name: Helm Values Template Preview

on:
  push:
    branches:
      - '**'
  pull_request:

jobs:
  helm-template-values:
    name: Render Helm templates for changed values
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Detect changes and render Helm templates
        shell: bash
        run: |
          set -euo pipefail

          echo "GitHub event: $GITHUB_EVENT_NAME"

          # Descobre o diff base
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            BASE_REF="${GITHUB_BASE_REF}"
            echo "Pull request detected. Base ref: $BASE_REF"

            git fetch origin "$BASE_REF" --depth=1
            BASE_SHA=$(git merge-base HEAD "origin/$BASE_REF")
            changed_files=$(git diff --name-only "$BASE_SHA"...HEAD || true)
          else
            echo "Push detected. Using previous commit as base."
            if git rev-parse HEAD^ >/dev/null 2>&1; then
              changed_files=$(git diff --name-only HEAD^ HEAD || true)
            else
              echo "No previous commit found (initial commit)."
              changed_files=""
            fi
          fi

          echo "Changed files:"
          echo "${changed_files:-<none>}"

          # Filtra apenas values
          echo "$changed_files" | grep '^helm/values/' > changed_values.txt || true

          if [ ! -s changed_values.txt ]; then
            echo "No helm/values/ changes detected. Skipping Helm template rendering."
            exit 0
          fi

          echo "Changed values files:"
          cat changed_values.txt

          jobs_file=".helm_jobs.txt"
          > "$jobs_file"

          # Monta matriz type;service;env a partir dos arquivos alterados
          while read -r file; do
            [ -z "${file:-}" ] && continue

            # helm/values/<type>/<service>/<env>.yaml
            type=$(echo "$file" | cut -d'/' -f3)
            service=$(echo "$file" | cut -d'/' -f4)
            env_file=$(basename "$file")
            env="${env_file%.yaml}"

            if [ "$env" = "common" ]; then
              # common afeta dev e qa (se existirem)
              for candidate in dev qa; do
                if [ -f "helm/values/$type/$service/$candidate.yaml" ]; then
                  echo "$type;$service;$candidate" >> "$jobs_file"
                fi
              done
            else
              echo "$type;$service;$env" >> "$jobs_file"
            fi
          done < changed_values.txt

          if [ ! -s "$jobs_file" ]; then
            echo "No Helm jobs generated from helm/values changes. Nothing to render."
            exit 0
          fi

          sort -u "$jobs_file" -o "$jobs_file"

          echo "Planned Helm render jobs (type;service;env):"
          cat "$jobs_file"

          # Diretório e resumo dos templates renderizados
          output_dir="helm-template-output"
          mkdir -p "$output_dir"

          summary_file="$output_dir/summary.md"
          > "$summary_file"

          had_error=0

          # Renderiza cada combinação e grava em arquivo
          while IFS=';' read -r type service env; do
            [ -z "${type:-}" ] && continue

            case "$type" in
              bartender) chart="helm/charts/bartender" ;;
              nginx)     chart="helm/charts/nginx" ;;
              cronjob)   chart="helm/charts/cronjob" ;;
              *)
                echo "Unknown type '$type' for service '$service'. Skipping."
                continue
                ;;
            esac

            common_file="helm/values/$type/$service/common.yaml"
            env_file="helm/values/$type/$service/$env.yaml"

            if [ ! -f "$common_file" ]; then
              echo "Common values '$common_file' not found. Skipping $type/$service/$env."
              continue
            fi

            if [ ! -f "$env_file" ]; then
              echo "Environment values '$env_file' not found. Skipping $type/$service/$env."
              continue
            fi

            echo "=============================================="
            echo " Rendering: type=$type service=$service env=$env"
            echo " Chart:     $chart"
            echo " Values:    $common_file + $env_file"
            echo "=============================================="

            output_file="$output_dir/${type}-${service}-${env}.yaml"
            error_file="$output_dir/${type}-${service}-${env}-error.log"

            # tenta renderizar, separando stdout (YAML) e stderr (erros)
            if helm template "$service-$env" "$chart" \
              -f "$common_file" \
              -f "$env_file" > "$output_file" 2> "$error_file"; then

              # sucesso: apaga log de erro vazio e registra no resumo
              if [ ! -s "$error_file" ]; then
                rm -f "$error_file"
              fi

              echo "- ✅ $type / $service ($env) — rendered to \`$output_file\`" >> "$summary_file"
            else
              had_error=1
              echo "::error::Helm template failed for $type/$service/$env. See $error_file in artifact 'helm-templates'."

              err_snippet=$(head -n 15 "$error_file" || echo "no error output")

              {
                echo "- ❌ $type / $service ($env) — template failed."
                echo ""
                echo "  Error (first lines):"
                echo ""
                echo '  ```'
                echo "$err_snippet" | sed 's/^/  /'
                echo '  ```'
              } >> "$summary_file"
            fi
          done < "$jobs_file"

          # Joga o resumo também no Job Summary do GitHub
          if [ -s "$summary_file" ]; then
            {
              echo "## Helm values validation"
              cat "$summary_file"
            } >> "$GITHUB_STEP_SUMMARY"
          fi

          # Se algum job quebrou, falha o workflow
          if [ "$had_error" -ne 0 ]; then
            exit 1
          fi

      - name: Upload rendered Helm templates
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: helm-templates
          path: helm-template-output
          if-no-files-found: ignore
          retention-days: 7

      - name: Comment summary on pull request
        if: ${{ always() && github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = 'helm-template-output/summary.md';

            let summary = '';
            try {
              summary = fs.readFileSync(path, 'utf8');
            } catch (err) {
              summary = '_No Helm summary file found._';
            }

            const prNumber = context.payload.pull_request.number;

            const body = [
              '## Helm values validation',
              '',
              summary,
              '',
              'Artifacts: check the **helm-templates** artifact in this workflow run.'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body
            });
