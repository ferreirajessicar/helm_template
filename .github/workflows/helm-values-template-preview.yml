name: Helm Values Template Preview

permissions:
  contents: read
  issues: write
  pull-requests: write

on:
  push:
    branches:
      - '**'
  pull_request:

jobs:
  helm-template-values:
    # não roda em pushes feitos pelo Argo Image Updater
    if: ${{ !(github.event_name == 'push' && github.actor == 'argocd-image-updater') }}
    name: Render Helm templates for changed values
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Detect changes and render Helm templates with diff
        shell: bash
        run: |
          set -euo pipefail

          echo "GitHub event: $GITHUB_EVENT_NAME"

          BASE_SHA=""

          # Descobre o diff base
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            BASE_REF="${GITHUB_BASE_REF}"
            echo "Pull request detected. Base ref: $BASE_REF"

            git fetch origin "$BASE_REF" --depth=1
            BASE_SHA=$(git merge-base HEAD "origin/$BASE_REF")
          else
            echo "Push detected. Using previous commit as base."
            if git rev-parse HEAD^ >/dev/null 2>&1; then
              BASE_SHA=$(git rev-parse HEAD^)
            else
              echo "No previous commit found (initial commit)."
              BASE_SHA=""
            fi
          fi

          if [ -n "${BASE_SHA:-}" ]; then
            echo "Base SHA for 'before' rendering: $BASE_SHA"
          else
            echo "No BASE_SHA available. 'Before' render may be skipped."
          fi

          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            changed_files=$(git diff --name-only "$BASE_SHA"...HEAD || true)
          else
            if [ -n "${BASE_SHA:-}" ]; then
              changed_files=$(git diff --name-only "$BASE_SHA" HEAD || true)
            else
              changed_files=$(git diff --name-only HEAD || true)
            fi
          fi

          echo "Changed files:"
          echo "${changed_files:-<none>}"

          # Filtra apenas values
          echo "$changed_files" | grep '^helm/values/' > changed_values.txt || true

          if [ ! -s changed_values.txt ]; then
            echo "No helm/values/ changes detected. Skipping Helm template rendering."
            exit 0
          fi

          echo "Changed values files:"
          cat changed_values.txt

          jobs_file=".helm_jobs.txt"
          > "$jobs_file"

          # Monta matriz type;service;env a partir dos arquivos alterados
          while read -r file; do
            [ -z "${file:-}" ] && continue

            # helm/values/<type>/<service>/<env>.yaml
            type=$(echo "$file" | cut -d'/' -f3)
            service=$(echo "$file" | cut -d'/' -f4)
            env_file=$(basename "$file")
            env="${env_file%.yaml}"

            if [ "$env" = "common" ]; then
              # common afeta dev e qa (se existirem)
              for candidate in dev qa; do
                if [ -f "helm/values/$type/$service/$candidate.yaml" ]; then
                  echo "$type;$service;$candidate" >> "$jobs_file"
                fi
              done
            else
              echo "$type;$service;$env" >> "$jobs_file"
            fi
          done < changed_values.txt

          if [ ! -s "$jobs_file" ]; then
            echo "No Helm jobs generated from helm/values changes. Nothing to render."
            exit 0
          fi

          sort -u "$jobs_file" -o "$jobs_file"

          echo "Planned Helm render jobs (type;service;env):"
          cat "$jobs_file"

          output_dir="helm-template-output"
          mkdir -p "$output_dir"

          summary_file="$output_dir/summary.md"
          > "$summary_file"

          had_error=0

          # Renderiza cada combinação (antes/depois) e gera diff
          while IFS=';' read -r type service env; do
            [ -z "${type:-}" ] && continue

            case "$type" in
              bartender) chart="helm/charts/bartender" ;;
              nginx)     chart="helm/charts/nginx" ;;
              cronjob)   chart="helm/charts/cronjob" ;;
              *)
                echo "Unknown type '$type' for service '$service'. Skipping."
                continue
                ;;
            esac

            path_common="helm/values/$type/$service/common.yaml"
            path_env="helm/values/$type/$service/$env.yaml"

            common_file="$path_common"
            env_file="$path_env"

            if [ ! -f "$common_file" ]; then
              echo "Common values '$common_file' not found. Skipping $type/$service/$env."
              continue
            fi

            if [ ! -f "$env_file" ]; then
              echo "Environment values '$env_file' not found. Skipping $type/$service/$env."
              continue
            fi

            echo "=============================================="
            echo " Rendering AFTER: type=$type service=$service env=$env"
            echo " Chart:          $chart"
            echo " Values (after): $common_file + $env_file"
            echo "=============================================="

            after_file="$output_dir/${type}-${service}-${env}-after.yaml"
            after_error_file="$output_dir/${type}-${service}-${env}-after-error.log"

            # Renderiza o DEPOIS (estado atual)
            if ! helm template "$service-$env" "$chart" \
              -f "$common_file" \
              -f "$env_file" > "$after_file" 2> "$after_error_file"; then

              had_error=1
              err_snippet=$(head -n 20 "$after_error_file" || echo "no error output")

              {
                echo "### $type / $service ($env)"
                echo ""
                echo "- ❌ Helm template FAILED for current values."
                echo ""
                echo "  Error (first lines):"
                echo ""
                echo '  ```'
                echo "$err_snippet" | sed 's/^/  /'
                echo '  ```'
                echo ""
              } >> "$summary_file"

              continue
            fi

            if [ ! -s "$after_error_file" ]; then
              rm -f "$after_error_file"
            fi

            before_file=""
            before_ok=0

            # Tenta renderizar o ANTES a partir do BASE_SHA
            if [ -n "${BASE_SHA:-}" ]; then
              if git cat-file -e "$BASE_SHA:$path_common" 2>/dev/null && git cat-file -e "$BASE_SHA:$path_env" 2>/dev/null; then
                echo "Rendering BEFORE for $type/$service/$env from $BASE_SHA"

                tmp_common_before=$(mktemp)
                tmp_env_before=$(mktemp)

                git show "$BASE_SHA:$path_common" > "$tmp_common_before"
                git show "$BASE_SHA:$path_env" > "$tmp_env_before"

                before_file="$output_dir/${type}-${service}-${env}-before.yaml"
                before_error_file="$output_dir/${type}-${service}-${env}-before-error.log"

                if helm template "$service-$env-before" "$chart" \
                  -f "$tmp_common_before" \
                  -f "$tmp_env_before" > "$before_file" 2> "$before_error_file"; then
                  before_ok=1
                  if [ ! -s "$before_error_file" ]; then
                    rm -f "$before_error_file"
                  fi
                else
                  echo "Failed to render BEFORE for $type/$service/$env (base $BASE_SHA)"
                  err_snippet_before=$(head -n 10 "$before_error_file" || echo "no error output")

                  {
                    echo "### $type / $service ($env)"
                    echo ""
                    echo "- ✅ Helm template rendered for current values."
                    echo "- ⚠️ Could not render previous version from base commit ($BASE_SHA)."
                    echo ""
                    echo "  Error rendering BEFORE (first lines):"
                    echo ""
                    echo '  ```'
                    echo "$err_snippet_before" | sed 's/^/  /'
                    echo '  ```'
                    echo ""
                  } >> "$summary_file"
                fi

                rm -f "$tmp_common_before" "$tmp_env_before"
              else
                echo "No previous values found at BASE_SHA for $type/$service/$env. Only AFTER will be shown."

                {
                  echo "### $type / $service ($env)"
                  echo ""
                  echo "- ✅ Helm template rendered for current values."
                  echo "- ℹ️ No previous values found at base commit ($BASE_SHA)."
                  echo ""
                } >> "$summary_file"
              fi
            else
              echo "No BASE_SHA set. Only AFTER will be shown for $type/$service/$env."

              {
                echo "### $type / $service ($env)"
                echo ""
                echo "- ✅ Helm template rendered for current values."
                echo "- ℹ️ No base commit available to compute BEFORE."
                echo ""
              } >> "$summary_file"
            fi

            # Se conseguimos renderizar ANTES e DEPOIS, gera diff
            if [ "$before_ok" -eq 1 ]; then
              diff_snippet=$(diff -u "$before_file" "$after_file" || true)

              # Se o diff for vazio, deixa claro também
              if [ -z "$diff_snippet" ]; then
                diff_snippet="(no differences between BEFORE and AFTER)"
              fi

              {
                echo "### $type / $service ($env)"
                echo ""
                echo "- ✅ Helm template rendered for previous and current values."
                echo ""
                echo "Diff (BEFORE → AFTER):"
                echo ""
                echo '```diff'
                echo "$diff_snippet"
                echo '```'
                echo ""
              } >> "$summary_file"
            fi

          done < "$jobs_file"

          # Joga o resumo também no Job Summary do GitHub
          if [ -s "$summary_file" ]; then
            {
              echo "## Helm values validation (before/after/diff)"
              echo ""
              cat "$summary_file"
            } >> "$GITHUB_STEP_SUMMARY"
          fi

          # Se algum AFTER quebrou, falha o workflow
          if [ "$had_error" -ne 0 ]; then
            exit 1
          fi

      - name: Validate rendered manifests with kubectl (dry-run=client)
        if: ${{ always() }}
        shell: bash
        run: |
          set -euo pipefail

          output_dir="helm-template-output"
          summary_file="$output_dir/summary.md"

          if [ ! -d "$output_dir" ]; then
            echo "No helm-template-output directory found. Skipping kubectl validation."
            exit 0
          fi

          yaml_files=$(find "$output_dir" -maxdepth 1 -type f -name '*-after.yaml' || true)

          if [ -z "$yaml_files" ]; then
            echo "No rendered AFTER YAML files found to validate with kubectl."
            exit 0
          fi

          echo "kubectl client version:"
          kubectl version --client

          had_error_kubectl=0

          {
            echo ""
            echo "## kubectl validation (dry-run=client)"
            echo ""
          } >> "$summary_file"

          for f in $yaml_files; do
            name=$(basename "$f")
            echo "Validating with kubectl: $f"

            if out=$(kubectl apply --dry-run=client -f "$f" 2>&1 >/dev/null); then
              echo "kubectl validation OK for $f"
              echo "- ✅ kubectl validation passed for \`$name\`" >> "$summary_file"
            else
              echo "::error::kubectl validation failed for $f"
              had_error_kubectl=1
              snippet=$(echo "$out" | head -n 15)

              {
                echo "- ❌ kubectl validation failed for \`$name\`"
                echo ""
                echo "  Error (first lines):"
                echo ""
                echo '  ```'
                echo "$snippet" | sed 's/^/  /'
                echo '  ```'
                echo ""
              } >> "$summary_file"
            fi
          done

          if [ "$had_error_kubectl" -ne 0 ]; then
            exit 1
          fi

      - name: Comment summary on pull request
        if: ${{ always() && github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = 'helm-template-output/summary.md';

            let summary = '';
            try {
              summary = fs.readFileSync(path, 'utf8');
            } catch (err) {
              summary = '_No Helm summary file found._';
            }

            const prNumber = context.payload.pull_request.number;

            const body = [
              '## Helm values validation (before / after / diff + kubectl)',
              '',
              summary
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body
            });
